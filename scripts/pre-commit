#!/bin/sh
#
# Pre-commit hook for terraform-mirror
# This hook checks for common issues that will be caught by the CI pipeline.
#
# To install this hook, run:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or on Windows (PowerShell):
#   Copy-Item scripts/pre-commit .git/hooks/pre-commit
#

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check failed
FAILED=0

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

# =============================================================================
# Check 1: Go formatting (gofmt)
# =============================================================================
echo ""
echo "Checking Go formatting..."

if [ -n "$STAGED_GO_FILES" ]; then
    UNFORMATTED=$(gofmt -l $STAGED_GO_FILES 2>&1 || true)
    if [ -n "$UNFORMATTED" ]; then
        echo "${RED}✗ The following files are not properly formatted:${NC}"
        echo "$UNFORMATTED"
        echo ""
        echo "Run 'gofmt -w <file>' to fix formatting, or 'gofmt -w .' to fix all files."
        FAILED=1
    else
        echo "${GREEN}✓ Go formatting check passed${NC}"
    fi
else
    echo "${YELLOW}○ No Go files staged, skipping format check${NC}"
fi

# =============================================================================
# Check 2: Go vet
# =============================================================================
echo ""
echo "Running go vet..."

if ! go vet ./... 2>&1; then
    echo "${RED}✗ go vet found issues${NC}"
    FAILED=1
else
    echo "${GREEN}✓ go vet passed${NC}"
fi

# =============================================================================
# Check 3: Go build (ensures code compiles)
# =============================================================================
echo ""
echo "Checking Go build..."

if ! go build ./... 2>&1; then
    echo "${RED}✗ Build failed${NC}"
    FAILED=1
else
    echo "${GREEN}✓ Build check passed${NC}"
fi

# =============================================================================
# Check 4: golangci-lint (if installed)
# =============================================================================
echo ""
echo "Running golangci-lint..."

if command -v golangci-lint >/dev/null 2>&1; then
    if ! golangci-lint run --timeout=5m 2>&1; then
        echo "${RED}✗ golangci-lint found issues${NC}"
        FAILED=1
    else
        echo "${GREEN}✓ golangci-lint passed${NC}"
    fi
else
    echo "${YELLOW}○ golangci-lint not installed, skipping (install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest)${NC}"
fi

# =============================================================================
# Check 5: Go tests (quick run without race detector for speed)
# =============================================================================
echo ""
echo "Running Go tests..."

if ! go test -short ./... 2>&1; then
    echo "${RED}✗ Tests failed${NC}"
    FAILED=1
else
    echo "${GREEN}✓ Tests passed${NC}"
fi

# =============================================================================
# Check 6: Check for common mistakes
# =============================================================================
echo ""
echo "Checking for common mistakes..."

# Check for fmt.Println debugging statements in non-test files
if [ -n "$STAGED_GO_FILES" ]; then
    DEBUG_PRINTS=$(echo "$STAGED_GO_FILES" | xargs grep -l 'fmt\.Println' 2>/dev/null | grep -v '_test\.go$' || true)
    if [ -n "$DEBUG_PRINTS" ]; then
        echo "${YELLOW}⚠ Warning: Found fmt.Println in non-test files (possible debug statements):${NC}"
        echo "$DEBUG_PRINTS"
        # This is a warning, not a failure
    fi
fi

# Check for TODO/FIXME comments (informational only)
if [ -n "$STAGED_GO_FILES" ]; then
    TODOS=$(echo "$STAGED_GO_FILES" | xargs grep -n 'TODO\|FIXME' 2>/dev/null || true)
    if [ -n "$TODOS" ]; then
        echo "${YELLOW}○ Found TODO/FIXME comments (informational):${NC}"
        echo "$TODOS"
    fi
fi

echo "${GREEN}✓ Common mistakes check passed${NC}"

# =============================================================================
# Final result
# =============================================================================
echo ""
if [ $FAILED -eq 1 ]; then
    echo "${RED}═══════════════════════════════════════════════════════════════${NC}"
    echo "${RED}Pre-commit checks FAILED. Please fix the issues above.${NC}"
    echo "${RED}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo "To bypass this hook (not recommended), use: git commit --no-verify"
    exit 1
else
    echo "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo "${GREEN}All pre-commit checks passed!${NC}"
    echo "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    exit 0
fi
