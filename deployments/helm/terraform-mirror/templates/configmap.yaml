apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "terraform-mirror.fullname" . }}-config
  labels:
    {{- include "terraform-mirror.labels" . | nindent 4 }}
data:
  config.hcl: |
    server {
      port     = "{{ .Values.config.server.port }}"
      hostname = "{{ .Values.config.server.hostname }}"
    }

    storage {
      {{- if eq .Values.config.storage.type "local" }}
      type       = "local"
      local_path = "{{ .Values.config.storage.localPath }}"
      {{- else }}
      type              = "s3"
      s3_endpoint       = "{{ include "terraform-mirror.s3Endpoint" . }}"
      s3_bucket         = "{{ .Values.config.storage.s3.bucket }}"
      s3_region         = "{{ .Values.config.storage.s3.region }}"
      s3_use_path_style = {{ .Values.config.storage.s3.usePathStyle }}
      {{- end }}
    }

    database {
      path                  = "{{ .Values.config.database.path }}"
      {{- if .Values.config.database.backupEnabled }}
      backup_enabled        = true
      backup_interval_hours = {{ .Values.config.database.backupIntervalHours }}
      backup_to_s3          = {{ .Values.config.database.backupToS3 }}
      backup_s3_prefix      = "{{ .Values.config.database.backupS3Prefix }}"
      {{- end }}
    }

    cache {
      enabled          = {{ .Values.config.cache.enabled }}
      {{- if .Values.config.cache.enabled }}
      memory_mb        = {{ .Values.config.cache.memoryMB }}
      ttl_minutes      = {{ .Values.config.cache.ttlMinutes }}
      disk_enabled     = {{ .Values.config.cache.diskEnabled }}
      disk_path        = "{{ .Values.config.cache.diskPath }}"
      disk_max_mb      = {{ .Values.config.cache.diskMaxMB }}
      disk_ttl_minutes = {{ .Values.config.cache.diskTtlMinutes }}
      {{- end }}
    }

    features {
      multi_platform = {{ .Values.config.features.multiPlatform }}
      enable_admin   = {{ .Values.config.features.enableAdmin }}
    }

    auth {
      token_expiry = "{{ .Values.config.auth.tokenExpiry }}"
    }

    processor {
      enabled          = {{ .Values.config.processor.enabled }}
      workers          = {{ .Values.config.processor.workers }}
      download_timeout = "{{ .Values.config.processor.downloadTimeout }}"
      retry_attempts   = {{ .Values.config.processor.retryAttempts }}
      retry_delay      = "{{ .Values.config.processor.retryDelay }}"
    }

    logging {
      level  = "{{ .Values.config.logging.level }}"
      format = "{{ .Values.config.logging.format }}"
    }

    {{- if .Values.config.telemetry.enabled }}
    telemetry {
      enabled         = true
      prometheus_path = "{{ .Values.config.telemetry.prometheusPath }}"
    }
    {{- end }}
